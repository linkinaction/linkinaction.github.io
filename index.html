<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link in Action - Your Link to Calgaryâ€™s Community Resources</title>

    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts for professional typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Updated Google Fonts to include Playfair Display and Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import 'query' along with other Firestore functions
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // These variables are expected to be injected by the environment.
        // Default values are provided for local testing.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "test", authDomain: "test.firebaseapp.com", projectId: "test" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Make Firebase instances globally available ---
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.appId = appId;
        window.currentUserId = null;
        window.isAuthReady = false;
        // Make 'query' function globally available for use in scripts
        window.firebaseQuery = query;

        // --- Authentication State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                window.currentUserId = user.uid;
                console.log("Firebase Auth: Authenticated user ID:", window.currentUserId);
            } else {
                // User is signed out. Attempt to sign in.
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase Auth: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase Auth: Signed in anonymously.");
                    }
                    window.currentUserId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Firebase Auth: Error during authentication:", error);
                }
            }
            // --- Signal that authentication is ready ---
            if (!window.isAuthReady) {
                window.isAuthReady = true;
                document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                console.log("Firebase Auth: 'firebaseAuthReady' event dispatched.");
            }
        });
    </script>

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif; /* Changed body font to Inter */
            background-color: #FDF4F4; /* Lighter, softer red background */
        }
        /* Updated font-family for headings and site title to Playfair Display */
        h1, h2, h3, .nav-link.text-2xl {
            font-family: 'Playfair Display', serif;
        }
        /* Style for the active navigation link */
        .nav-link.active {
            color: #B91C1C; /* Slightly darker red for active link */
            font-weight: 600;
        }
        /* Hide sections by default and add fade-in transition */
        .page-section {
            display: none;
            opacity: 0;
            transition: opacity 0.7s ease-in-out; /* Slower transition for smoother feel */
        }
        /* Show the active section */
        .page-section.active {
            display: block;
            opacity: 1;
        }
        /* Custom styling for map container */
        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        /* Custom theme colors */
        .bg-primary-hero { background-color: #881C1C; } /* Deep Red */
        .bg-primary-hero-overlay { background-color: #A32A2A; } /* Slightly lighter deep red */
        .text-primary-accent { color: #B91C1C; } /* Vibrant Red */
        .hover\:text-primary-accent:hover { color: #991B1B; } /* Darker red on hover */
        .bg-primary-button { background-color: #B91C1C; } /* Vibrant Red */
        .hover\:bg-primary-button-dark:hover { background-color: #991B1B; } /* Darker red on hover */
        .focus\:ring-primary:focus { ring-color: #B91C1C; }
        .border-primary { border-color: #B91C1C; }
        .bg-footer-dark-red { background-color: #4A0404; } /* Very dark red for footer */


        /* Hero text animation */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeInDown {
            animation: fadeInDown 1s ease-out forwards;
        }
        .animate-fadeInDown-delay-1 {
            animation: fadeInDown 1s ease-out 0.3s forwards;
            opacity: 0;
        }
        .animate-fadeInDown-delay-2 {
            animation: fadeInDown 1s ease-out 0.6s forwards;
            opacity: 0;
        }

        /* Fade in animation for section content */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadeIn {
            animation: fadeIn 1s ease-out forwards;
        }

        /* Slide in from bottom animation */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slideInUp {
            animation: slideInUp 0.8s ease-out forwards;
        }

        /* Loading spinner for contact form */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #B91C1C;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#home" class="nav-link text-2xl font-bold text-gray-900">Link in Action</a>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center space-x-8">
                <a href="#home" class="nav-link text-gray-600 hover:text-primary-accent transition-colors duration-300 active">Home</a>
                <a href="#directory" class="nav-link text-gray-600 hover:text-primary-accent transition-colors duration-300">Community Directory</a>
                <a href="#join" class="nav-link text-gray-600 hover:text-primary-accent transition-colors duration-300">Join the Network</a>
                <a href="#about" class="nav-link text-gray-600 hover:text-primary-accent transition-colors duration-300">About</a>
                <a href="#contact" class="nav-link text-gray-600 hover:text-primary-accent transition-colors duration-300">Contact</a>
            </nav>

            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-gray-900 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200">
            <a href="#home" class="nav-link block px-6 py-3 text-gray-600 hover:bg-gray-100">Home</a>
            <a href="#directory" class="nav-link block px-6 py-3 text-gray-600 hover:bg-gray-100">Community Directory</a>
            <a href="#join" class="nav-link block px-6 py-3 text-gray-600 hover:bg-gray-100">Join the Network</a>
            <a href="#about" class="nav-link block px-6 py-3 text-gray-600 hover:bg-gray-100">About</a>
            <a href="#contact" class="nav-link block px-6 py-3 text-gray-600 hover:bg-gray-100">Contact</a>
        </div>
    </header>

    <!-- Main Content Area -->
    <main>
        <!-- Home Section -->
        <section id="home" class="page-section active">
            <div class="relative bg-primary-hero overflow-hidden rounded-b-3xl shadow-lg">
                <div class="absolute inset-0">
                    <!-- Calgary-themed hero image -->
                    <img class="w-full h-full object-cover" src="https://images.unsplash.com/photo-1587883983034-4a433f3e6465?q=80&w=2070&auto=format&fit=crop" alt="Calgary skyline with Peace Bridge" onerror="this.onerror=null;this.src='https://placehold.co/1600x900/881C1C/ffffff?text=Calgary+Skyline';">
                    <div class="absolute inset-0 bg-primary-hero-overlay opacity-70 mix-blend-multiply" aria-hidden="true"></div>
                </div>
                <div class="relative max-w-4xl mx-auto text-center py-24 px-6 sm:py-32 lg:py-48">
                    <h1 class="text-4xl font-extrabold tracking-tight text-white sm:text-5xl lg:text-6xl animate-fadeInDown">Welcome to Link In Action</h1>
                    <p class="mt-6 text-xl text-red-100 animate-fadeInDown-delay-1">Your Link to Calgaryâ€™s Community Resources</p>
                    <a href="#directory" class="nav-link mt-8 w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-medium text-primary-accent bg-white hover:bg-red-50 sm:w-auto transition-all duration-300 transform hover:scale-105 animate-fadeInDown-delay-2">
                        Explore Community Resources
                    </a>
                </div>
            </div>
             <div class="bg-white py-16 sm:py-24 rounded-t-3xl shadow-inner -mt-8 relative z-10 animate-fadeIn">
                <div class="max-w-4xl mx-auto px-6 sm:px-8 lg:px-12 text-center">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4 animate-slideInUp">Link In Action</h2>
                    <p class="mt-4 text-lg text-gray-600 leading-relaxed animate-slideInUp">Calgaryâ€™s centralized platform for discovering community programs and services. Whether youâ€™re new to the city or seeking support, we make it easy to find the right programs for your needs. With many organizations providing similar services and important resources often hard to find, Link In Action brings clarity, access, and connection to the forefront of community support.</p>
                </div>
            </div>
        </section>

        <!-- Community Directory Section -->
        <section id="directory" class="page-section py-16 sm:py-24 bg-gray-50">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl animate-slideInUp">Community Directory</h2>
                    <p class="mt-4 text-lg text-gray-600 animate-slideInUp">Find the resources you need, right in your community.</p>
                </div>

                <!-- Search Form - Enhanced with more filters -->
                <div class="bg-white p-8 rounded-xl shadow-lg mb-12 border border-gray-100 animate-fadeIn">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6">
                        <input type="text" placeholder="Search by keyword" class="col-span-1 xl:col-span-2 w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                        <select class="w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                            <option value="">Program Type</option>
                            <option value="legal-aid">Legal Aid</option>
                            <option value="housing">Housing</option>
                            <option value="language-classes">Language Classes</option>
                            <option value="employment">Employment Services</option>
                            <option value="health">Health & Wellness</option>
                            <option value="education">Education</option>
                            <option value="food-security">Food Security</option>
                        </select>
                        <select class="w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                            <option value="">Location</option>
                            <option value="ne">NE Calgary</option>
                            <option value="nw">NW Calgary</option>
                            <option value="se">SE Calgary</option>
                            <option value="sw">SW Calgary</option>
                            <option value="downtown">Downtown</option>
                        </select>
                        <select class="w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                            <option value="">Price</option>
                            <option value="free">Free</option>
                            <option value="low-cost">Low Cost</option>
                            <option value="paid">Paid</option>
                        </select>
                        <select class="w-full p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                            <option value="">Age Group</option>
                            <option value="children">Children (0-12)</option>
                            <option value="youth">Youth (13-18)</option>
                            <option value="adults">Adults (19-64)</option>
                            <option value="seniors">Seniors (65+)</option>
                            <option value="all">All Ages</option>
                        </select>
                        <button class="w-full bg-primary-button text-white p-3 rounded-lg font-semibold hover:bg-primary-button-dark transition-all duration-300 transform hover:scale-105 shadow-md">Search</button>
                    </div>
                </div>

                <!-- Google Map -->
                <div id="map" class="bg-gray-200 rounded-xl shadow-lg mb-12 border border-gray-100 animate-fadeIn"></div>
            </div>
        </section>

        <!-- Join the Network Section -->
        <section id="join" class="page-section py-16 sm:py-24 bg-white">
            <div class="container mx-auto px-6">
                 <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl animate-slideInUp">Join the Network</h2>
                    <p class="mt-4 text-lg text-gray-600 animate-slideInUp">Be an active part of Calgary's community fabric. Your involvement strengthens our city.</p>
                </div>
                <div class="grid md:grid-cols-1 lg:grid-cols-3 gap-8 text-left">
                    <div class="bg-gray-50 p-8 rounded-xl shadow-md transition-shadow duration-300 hover:shadow-xl hover:translate-y-[-5px] border border-gray-100 animate-slideInUp">
                        <h3 class="text-xl font-bold mb-4 text-primary-accent">Volunteer Opportunities</h3>
                        <p class="text-gray-600 mb-4 leading-relaxed">Lend your time and skills to make a tangible impact. Organizations across Calgary are seeking passionate individuals to support their missions. From event support to program assistance, find a role that fits your passion.</p>
                        <p class="text-gray-600 leading-relaxed">Organizations may list specific volunteer opportunities here once they have joined our network. (Pending consent)</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-xl shadow-md transition-shadow duration-300 hover:shadow-xl hover:translate-y-[-5px] border border-gray-100 animate-slideInUp" style="animation-delay: 0.2s;">
                        <h3 class="text-xl font-bold mb-4 text-primary-accent">Calls to Action</h3>
                        <p class="text-gray-600 mb-4 leading-relaxed">Respond to immediate needs within the community. This space is dedicated to time-sensitive requests, such as donations for a winter clothing drive, advocacy for a community issue, or support for a local event.</p>
                        <p class="text-gray-600 leading-relaxed">This feature allows for dynamic, real-time collaboration between community members and organizations to address pressing needs as they arise.</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-xl shadow-md transition-shadow duration-300 hover:shadow-xl hover:translate-y-[-5px] border border-gray-100 animate-slideInUp" style="animation-delay: 0.4s;">
                        <h3 class="text-xl font-bold mb-4 text-primary-accent">Participate in Research</h3>
                        <p class="text-gray-600 mb-4 leading-relaxed">Contribute to the understanding of our community by participating in vital research. Academic institutions and organizations often seek participants for studies related to immigrant and newcomer experiences in Calgary.</p>
                        <p class="text-gray-600 leading-relaxed">Your participation can help shape future programs and policies, ensuring they are effective and culturally sensitive. Research posters and calls for participants will be listed here.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section id="about" class="page-section py-16 sm:py-24 bg-gray-50">
            <div class="container mx-auto px-6 max-w-4xl">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl animate-slideInUp">About Us</h2>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 space-y-12 animate-fadeIn">
                    <div>
                        <h3 class="text-2xl font-bold text-primary-accent mb-4 animate-slideInUp">Our Mission</h3>
                        <p class="text-lg text-gray-600 leading-relaxed animate-slideInUp">Link In Action was developed to enhance access to community services by providing a centralized, user-friendly digital platform that connects individuals with local organizations and programs in Calgary. Our mission is to bridge service gaps, promote inclusion, and empower individuals through streamlined access to vital resources.</p>
                    </div>
                     <div>
                        <h3 class="text-2xl font-bold text-primary-accent mb-4 animate-slideInUp">Our Objectives</h3>
                        <ul class="list-disc list-inside space-y-2 text-lg text-gray-600 ml-4 animate-slideInUp">
                            <li>Empower users through customized search tools</li>
                            <li>Centralize access to community services</li>
                            <li>Enhance visibility and reduce redundancy</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-primary-accent mb-4 animate-slideInUp">Our Team</h3>
                        <p class="text-lg text-gray-600 leading-relaxed animate-slideInUp">Meet the people behind Link In Action: Jasman & Arfa.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Section -->
        <section id="contact" class="page-section py-16 sm:py-24 bg-white">
            <div class="container mx-auto px-6 max-w-2xl">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl animate-slideInUp">Contact Us</h2>
                     <p class="mt-4 text-lg text-gray-600 animate-slideInUp">If you have questions or need assistance, please reach out to us.</p>
                </div>
                <form id="contact-form" class="bg-gray-50 p-8 rounded-xl shadow-lg border border-gray-100 space-y-6 animate-fadeIn">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="contact-name" name="name" required class="mt-1 block w-full p-3 rounded-lg border-gray-300 shadow-sm focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                    </div>
                     <div>
                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="contact-email" name="email" required class="mt-1 block w-full p-3 rounded-lg border-gray-300 shadow-sm focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200">
                    </div>
                     <div>
                        <label for="contact-message" class="block text-sm font-medium text-gray-700">Message</label>
                        <textarea id="contact-message" name="message" rows="5" required class="mt-1 block w-full p-3 rounded-lg border-gray-300 shadow-sm focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200"></textarea>
                    </div>
                    <div>
                         <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-primary-button hover:bg-primary-button-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all duration-300 transform hover:scale-105">
                            Send Message
                        </button>
                        <div id="contact-form-message" class="mt-4 text-center text-sm flex items-center justify-center">
                            <!-- This message will be updated dynamically by JavaScript -->
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-footer-dark-red text-white"> 
        <div class="container mx-auto py-8 px-6 text-center">
            <div class="flex justify-center space-x-6 mb-6">
                <!-- LinkedIn Image Icon -->
                <a href="https://www.linkedin.com/company/linkinaction" target="_blank" aria-label="LinkedIn" class="text-white hover:opacity-75 transition-opacity">
                    <img src="https://placehold.co/28x28/0A66C2/ffffff?text=LI" alt="LinkedIn Logo" class="w-7 h-7 rounded-md">
                </a>
                <!-- Instagram Image Icon -->
                <a href="https://www.instagram.com/linkinaction" target="_blank" aria-label="Instagram" class="text-white hover:opacity-75 transition-opacity">
                    <img src="https://placehold.co/28x28/E1306C/ffffff?text=IG" alt="Instagram Logo" class="w-7 h-7 rounded-md">
                </a>
                <!-- Email Image Icon -->
                <a href="mailto:linkinaction@gmail.com" aria-label="Email" class="text-white hover:opacity-75 transition-opacity">
                    <img src="https://placehold.co/28x28/D44638/ffffff?text=Email" alt="Email Icon" class="w-7 h-7 rounded-md">
                </a>
            </div>
            <p class="text-sm text-red-100">&copy; 2025 Link In Action. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- Google Maps API Key ---
        // Replace with your actual key in a production environment.
        // If left empty, the map may not load correctly and will show an API error.
        const GOOGLE_MAPS_API_KEY = ''; 

        document.addEventListener('DOMContentLoaded', function() {
            // --- Element Selectors ---
            const sections = document.querySelectorAll('.page-section');
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            // --- State Variables ---
            let map;
            let markers = [];

            // --- Google Maps Initialization ---
            function loadGoogleMapsScript() {
                if (document.getElementById('google-maps-script')) return; // Already loaded
                const script = document.createElement('script');
                script.id = 'google-maps-script';
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
                script.onerror = () => console.error("Map: Failed to load Google Maps script. Check your API key and network connection.");
            }

            window.initMap = function() {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;

                const calgary = { lat: 51.0447, lng: -114.0719 };
                map = new google.maps.Map(mapElement, {
                    center: calgary,
                    zoom: 11,
                    mapId: 'DEMO_MAP_ID', // Use a demo map ID or your own
                });
                console.log("Map: Google Map initialized.");

                // Fetch resources only after auth is ready
                if (window.isAuthReady) {
                    fetchResourcesAndAddMarkers();
                } else {
                    document.addEventListener('firebaseAuthReady', fetchResourcesAndAddMarkers, { once: true });
                }
            };

            function addMarker(location, title, description) {
                if (!map) return;
                const marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: title,
                    animation: google.maps.Animation.DROP,
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `<div class="font-sans"><strong>${title}</strong><br>${description}</div>`
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                markers.push(marker);
            }

            // --- Page Navigation Logic ---
            function showSection(hash) {
                const targetHash = (hash === '' || hash === '#') ? '#home' : hash;
                
                sections.forEach(section => section.classList.remove('active'));

                const targetSection = document.querySelector(targetHash);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === targetHash);
                });
                
                mobileMenu.classList.add('hidden');
                window.scrollTo(0, 0);

                // Initialize map if navigating to the directory section
                if (targetHash === '#directory' && !map) {
                    loadGoogleMapsScript();
                }
            }

            // --- Firebase Firestore Data Fetching ---
            function fetchResourcesAndAddMarkers() {
                // Ensure firebaseDb and firebaseQuery are available globally
                if (!window.firebaseDb || !window.appId || !window.firebaseQuery) {
                    console.warn("Firestore: DB, App ID, or Query function not available.");
                    return;
                }

                // Use window.firebaseQuery to call the query function
                const q = window.firebaseQuery(collection(window.firebaseDb, `artifacts/${window.appId}/public/data/community_resources`));

                onSnapshot(q, (snapshot) => {
                    // Clear existing markers
                    markers.forEach(marker => marker.setMap(null));
                    markers = [];

                    if (snapshot.empty) {
                        console.log("Firestore: No community resources found.");
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const resource = doc.data();
                        // Use dummy coordinates for now. In a real app, you'd geocode the address.
                        const latOffset = (Math.random() - 0.5) * 0.1;
                        const lngOffset = (Math.random() - 0.5) * 0.1;
                        const location = { lat: 51.0447 + latOffset, lng: -114.0719 + lngOffset };
                        addMarker(location, resource.name, resource.description);
                    });
                }, (error) => {
                    console.error("Firestore: Error fetching documents: ", error);
                });
            }

            // --- Contact Form Submission ---
            const contactForm = document.getElementById('contact-form');
            if (contactForm) {
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const messageDiv = document.getElementById('contact-form-message');
                    messageDiv.innerHTML = '<span class="spinner"></span>Sending...';
                    messageDiv.className = "mt-4 text-center text-sm text-gray-600 flex items-center justify-center";

                    const formData = new FormData(contactForm);
                    const payload = Object.fromEntries(formData.entries());

                    try {
                        const response = await fetch('/send-email', { // This is the endpoint for your backend
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                        });

                        if (response.ok) {
                            messageDiv.innerHTML = 'Message sent successfully!';
                            messageDiv.classList.add('text-green-600');
                            contactForm.reset();
                        } else {
                            const errorData = await response.json();
                            messageDiv.innerHTML = `Failed to send message: ${errorData.error || 'Unknown error'}`;
                            messageDiv.classList.add('text-red-600');
                        }
                    } catch (error) {
                        console.error('Error sending contact form:', error);
                        messageDiv.innerHTML = 'Failed to send message. Please try again.';
                        messageDiv.classList.add('text-red-600');
                    }
                });
            }

            // --- Event Listeners for Navigation ---
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetHash = this.getAttribute('href');
                    history.pushState(null, null, targetHash);
                    showSection(targetHash);
                });
            });

            window.addEventListener('popstate', () => showSection(window.location.hash));
            
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

            // --- Initial Page Load ---
            showSection(window.location.hash);
        });
    </script>
</body>
</html>
